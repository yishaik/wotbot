<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WotBot Admin</title>
    <style>
      :root {
        --bg: #0f172a;
        --panel: #111827;
        --text: #e5e7eb;
        --muted: #9ca3af;
        --accent: #22c55e;
        --danger: #ef4444;
        --border: #1f2937;
      }
      * { box-sizing: border-box; }
      body { font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); margin: 0; }
      .nav { background: #0b1220; border-bottom: 1px solid var(--border); padding: 14px 22px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; }
      .nav h1 { margin: 0; font-size: 18px; letter-spacing: 0.3px; }
      .container { max-width: 1080px; margin: 24px auto; padding: 0 16px; }
      .grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 16px; }
      .card { grid-column: span 12; background: var(--panel); border: 1px solid var(--border); border-radius: 10px; padding: 16px; }
      @media (min-width: 900px) {
        .span-6 { grid-column: span 6; }
        .span-4 { grid-column: span 4; }
        .span-8 { grid-column: span 8; }
      }
      .card h2 { margin: 0 0 8px 0; font-size: 16px; }
      .desc { color: var(--muted); font-size: 13px; margin-bottom: 12px; }
      .row { display: grid; grid-template-columns: 180px 1fr; align-items: center; gap: 10px; margin: 8px 0; }
      label { color: var(--muted); font-size: 13px; }
      input[type=text], input[type=password], textarea { width: 100%; padding: 10px 12px; background: #0b1220; color: var(--text); border: 1px solid var(--border); border-radius: 8px; }
      textarea { resize: vertical; min-height: 60px; }
      .switch { display: inline-flex; align-items: center; gap: 10px; }
      .btn { appearance: none; border: 1px solid var(--border); background: #0b1220; color: var(--text); padding: 8px 12px; border-radius: 8px; cursor: pointer; }
      .btn:hover { border-color: #334155; }
      .btn.accent { background: var(--accent); color: #0b1220; border: none; }
      .btn.danger { background: transparent; border-color: var(--danger); color: var(--danger); }
      .actions { display: flex; gap: 10px; flex-wrap: wrap; }
      .code { background: #0b1220; border: 1px dashed var(--border); color: #d1d5db; padding: 10px; border-radius: 8px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: 12px; overflow: auto; max-height: 260px; }
      .hint { color: var(--muted); font-size: 12px; }
      .badges { display: flex; gap: 8px; flex-wrap: wrap; }
      .badge { border: 1px solid var(--border); background: #0b1220; color: var(--muted); border-radius: 999px; padding: 4px 8px; font-size: 12px; }
      .success { color: var(--accent); }
    </style>
  </head>
  <body>
    <div class="nav">
      <h1>WotBot Admin</h1>
      <div class="badges">
        <span class="badge" id="assistant-badge">Assistant: -</span>
        <span class="badge" id="model-badge">Model: {{ OPENAI_MODEL }}</span>
      </div>
    </div>
    <div class="container">
      <div class="card span-12" style="margin-bottom:12px;">
        <div class="actions" id="tabs">
          <button class="btn" data-section="config">Configuration</button>
          <button class="btn" data-section="openai">OpenAI</button>
          <button class="btn" data-section="tools">Tools</button>
          <button class="btn" data-section="mcp">MCP</button>
          <button class="btn" data-section="twilio">Twilio</button>
          <button class="btn" data-section="system">System</button>
          <button class="btn" data-section="configio">Import/Export</button>
          <button class="btn" data-section="ai">AI Assistant</button>
        </div>
      </div>
      <div class="grid">
        <div class="card span-8" data-section="config">
          <h2>Configuration</h2>
          <div class="desc">Update runtime settings. Secrets are masked; leave blank to keep current. Save will apply immediately.</div>
          <form method="post" id="cfg-form">
            <div class="row">
              <label for="OPENAI_API_KEY">OpenAI API Key</label>
              <div>
                <input type="password" id="OPENAI_API_KEY" name="OPENAI_API_KEY" value="{{ OPENAI_API_KEY }}" />
                <div class="hint">Your OpenAI key. Click Save to apply.</div>
              </div>
            </div>
            <div class="row">
              <label for="OPENAI_MODEL">OpenAI Model</label>
              <input type="text" id="OPENAI_MODEL" name="OPENAI_MODEL" value="{{ OPENAI_MODEL }}" />
            </div>
            <div class="row">
              <label>Use Assistants</label>
              <div class="switch">
                <input type="checkbox" id="OPENAI_USE_ASSISTANTS" name="OPENAI_USE_ASSISTANTS" {% if OPENAI_USE_ASSISTANTS %}checked{% endif %} />
                <span class="hint">Enable to use the Assistants API (+ function tools).</span>
              </div>
            </div>
            <div class="row">
              <label>Use Responses</label>
              <div class="switch">
                <input type="checkbox" id="OPENAI_USE_RESPONSES" name="OPENAI_USE_RESPONSES" {% if OPENAI_USE_RESPONSES %}checked{% endif %} />
                <span class="hint">Prefer Responses API for tool-calling; falls back to Chat on errors.</span>
              </div>
            </div>
            <div class="row">
              <label for="OPENAI_ASSISTANT_ID">Assistant ID</label>
              <input type="text" id="OPENAI_ASSISTANT_ID" name="OPENAI_ASSISTANT_ID" value="{{ OPENAI_ASSISTANT_ID }}" />
            </div>
            <div class="row">
              <label for="ASSISTANT_INSTRUCTIONS">Assistant Instructions</label>
              <div>
                <textarea id="ASSISTANT_INSTRUCTIONS" name="ASSISTANT_INSTRUCTIONS" rows="4">{{ ASSISTANT_INSTRUCTIONS }}</textarea>
                <div class="hint">Controls the system behavior and tone. Used in both Assistants runs and chat system prompt.</div>
              </div>
            </div>
            <div class="row">
              <label for="OPENAI_TEMPERATURE">Temperature</label>
              <input type="text" id="OPENAI_TEMPERATURE" name="OPENAI_TEMPERATURE" value="{{ OPENAI_TEMPERATURE }}" />
            </div>
            <div class="row">
              <label for="OPENAI_MAX_TOKENS">Max Tokens</label>
              <input type="text" id="OPENAI_MAX_TOKENS" name="OPENAI_MAX_TOKENS" value="{{ OPENAI_MAX_TOKENS }}" />
            </div>
            <div class="row"><label></label>
              <div class="actions">
                <button class="btn" onclick="fetchModels();return false;">Fetch Models</button>
              </div>
            </div>
            <div class="row"><label>Models</label><div id="models" class="code"></div></div>
            <div class="row">
              <label for="TWILIO_ACCOUNT_SID">Twilio Account SID</label>
              <input type="password" id="TWILIO_ACCOUNT_SID" name="TWILIO_ACCOUNT_SID" value="{{ TWILIO_ACCOUNT_SID }}" />
            </div>
            <div class="row">
              <label for="TWILIO_AUTH_TOKEN">Twilio Auth Token</label>
              <input type="password" id="TWILIO_AUTH_TOKEN" name="TWILIO_AUTH_TOKEN" value="{{ TWILIO_AUTH_TOKEN }}" />
            </div>
            <div class="row">
              <label for="TWILIO_WHATSAPP_FROM">WhatsApp From</label>
              <div>
                <input type="text" id="TWILIO_WHATSAPP_FROM" name="TWILIO_WHATSAPP_FROM" value="{{ TWILIO_WHATSAPP_FROM }}" />
                <div class="hint">Sandbox: whatsapp:+14155238886. Real number uses your WhatsApp-enabled Twilio phone.</div>
              </div>
            </div>
            <div class="row">
              <label>Validate Signature</label>
              <div class="switch">
                <input type="checkbox" id="TWILIO_VALIDATE_SIGNATURE" name="TWILIO_VALIDATE_SIGNATURE" {% if TWILIO_VALIDATE_SIGNATURE %}checked{% endif %} />
                <span class="hint">Enable after PUBLIC_BASE_URL is set correctly.</span>
              </div>
            </div>
            <div class="row">
              <label for="PUBLIC_BASE_URL">Public Base URL</label>
              <input type="text" id="PUBLIC_BASE_URL" name="PUBLIC_BASE_URL" value="{{ PUBLIC_BASE_URL }}" />
            </div>
            <div class="row"><label></label>
              <div class="actions">
                <button class="btn accent" type="submit">Save Changes</button>
                <button class="btn" type="button" onclick="syncAssistant()">Sync Assistant Tools</button>
                <button class="btn danger" type="button" onclick="restart()">Restart</button>
              </div>
            </div>
            <div class="row"><label></label><div id="msg" class="hint"></div></div>
            <div class="row"><label>Admin Numbers</label><textarea id="ADMIN_PHONE_NUMBERS" name="ADMIN_PHONE_NUMBERS" rows="3">{{ ADMIN_PHONE_NUMBERS }}</textarea></div>
            <div class="row"><label>HTTP Allowlist</label><input type="text" id="ALLOW_HTTP_DOMAINS" name="ALLOW_HTTP_DOMAINS" value="{{ ALLOW_HTTP_DOMAINS }}" /></div>
            <div class="row"><label>MCP Servers</label><input type="text" id="MCP_SERVERS" name="MCP_SERVERS" value="{{ MCP_SERVERS }}" /></div>
            <div class="row"><label>MCP Token</label><input type="password" id="MCP_TOKEN" name="MCP_TOKEN" value="{{ MCP_TOKEN }}" /></div>
          </form>
        </div>
        <div class="card span-4" data-section="system">
          <h2>System</h2>
          <div class="desc">Quick status and logs. Use for troubleshooting.</div>
          <div class="actions" style="margin-bottom:8px;">
            <button class="btn" onclick="loadHealth()">Refresh Health</button>
            <button class="btn" onclick="loadLogs()">View Logs</button>
            <button class="btn" onclick="summarizeLogs()">Summarize Logs (AI)</button>
          </div>
          <div id="health" class="code">Loading...</div>
          <div style="height:8px"></div>
          <div id="logs" class="code"></div>
          <div style="height:8px"></div>
          <div id="logs-summary" class="code"></div>
        </div>
        <div class="card span-12" data-section="tools">
          <h2>Assistant Tools</h2>
          <div class="desc">Control which tools are exposed to the model, and see their JSON schemas and usage tips. Click Sync to push the current schema to OpenAI.</div>
          <div class="actions" style="margin-bottom:8px;">
            <button class="btn" onclick="loadTools()">Refresh Tools</button>
            <label class="switch"><input type="checkbox" id="enable-all" onchange="toggleEnableAll()"/> Enable all tools</label>
            <button class="btn" onclick="applyToolSelection()">Apply Tool Selection</button>
            <button class="btn" onclick="syncAssistant()">Sync with OpenAI</button>
          </div>
          <div id="tools-list" class="code">Loading tools...</div>
          <div style="height:8px"></div>
          <div class="desc">Effective schema preview (what the model will see):</div>
          <div id="tools-schema" class="code"></div>
          <div style="height:8px"></div>
          <div id="assistant-info" class="code">Loading assistant info...</div>
          <div class="hint">Usage tips:
            <ul>
              <li><b>run_code</b>: Small calculations or snippets. Avoid long-running jobs.</li>
              <li><b>http_request</b>: Fetch JSON or text. Domain must be allowlisted.</li>
              <li><b>mcp_call</b>: Call tools exposed by your MCP servers (see MCP section).</li>
              <li><b>get_system_status</b>, <b>read_log</b>, <b>read_config</b>, <b>restart_self</b>: Bot maintenance only.</li>
            </ul>
          </div>
        </div>
        <div class="card span-12" data-section="mcp" style="display:none;">
          <h2>MCP Configuration</h2>
          <div class="desc">Configure MCP servers and test connectivity. Use HTTP JSON-RPC URLs (e.g., <code>http://127.0.0.1:9010/jsonrpc</code>) or local command paths (e.g., <code>/home/user/.bin/mcp-weather --flag</code>). For HTTP, the MCP token is sent as Bearer if provided.</div>
          <input type="hidden" id="MCP_SERVERS" name="MCP_SERVERS" value="{{ MCP_SERVERS }}" form="cfg-form"/>
          <div class="row"><label for="MCP_TOKEN">MCP Token</label><input type="password" id="MCP_TOKEN" name="MCP_TOKEN" value="{{ MCP_TOKEN }}" form="cfg-form"/></div>
          <div class="row"><label>Servers</label>
            <div style="width:100%">
              <div id="mcp-rows"></div>
              <div class="actions" style="margin-top:6px"><button class="btn" type="button" onclick="mcpAddRow()">Add Server</button></div>
            </div>
          </div>
          <div class="actions" style="margin:10px 0;">
            <button class="btn" type="submit" form="cfg-form">Save MCP Settings</button>
          </div>
        </div>
        <div class="card span-12" data-section="twilio" style="display:none;">
          <h2>Twilio</h2>
          <div class="desc">Send a test WhatsApp message to verify delivery.</div>
          <div class="row"><label>From</label><div class="hint">{{ TWILIO_WHATSAPP_FROM }}</div></div>
          <div class="row"><label for="tw-to">To number</label><input id="tw-to" type="text" placeholder="whatsapp:+1..."/></div>
          <div class="row"><label for="tw-body">Message</label><textarea id="tw-body" rows="3">Hello from WotBot (test)</textarea></div>
          <div class="actions"><button class="btn" onclick="twilioTestSend()">Send Test</button></div>
          <div id="tw-result" class="code"></div>
        </div>
        <div class="card span-12" data-section="configio">
          <h2>Examples & Import/Export</h2>
          <div class="desc">Quick-start an example MCP server and manage configuration snapshots.</div>
          <div class="grid">
            <div class="span-8">
              <div class="code" style="margin-bottom:8px;">
                Example MCP server (echo/add):
                
                python examples/mcp_echo_server.py --host 127.0.0.1 --port 9010
                
                Then click “Add Local Example MCP” below.
              </div>
              <div class="actions">
                <button class="btn" onclick="addLocalMCP()">Add Local Example MCP</button>
                <button class="btn" onclick="testMCP()">Test MCP</button>
              </div>
            </div>
            <div class="span-4">
              <div class="actions" style="margin-bottom:8px;">
                <button class="btn" onclick="exportConfig()">Export Config</button>
                <label class="btn" for="import-file">Import Config</label>
                <input id="import-file" type="file" accept="application/json" style="display:none"/>
              </div>
              <div id="import-result" class="hint"></div>
            </div>
          </div>
        </div>
        <div class="card span-12" data-section="ai" style="display:none;">
          <h2>AI Assistant</h2>
          <div class="row"><label>Question</label><textarea id="ai-q" rows="3" placeholder="What would you like to know?"></textarea></div>
          <div class="actions">
            <label class="switch"><input type="checkbox" id="ai-logs"/> Include logs</label>
            <label class="switch"><input type="checkbox" id="ai-health"/> Include health</label>
            <label class="switch"><input type="checkbox" id="ai-tools"/> Include tools</label>
            <button class="btn" onclick="askAI()">Ask AI</button>
          </div>
          <div id="ai-answer" class="code"></div>
        </div>
      </div>
    </div>
    <script>
      // Tabs
      (function(){
        const buttons = document.querySelectorAll('#tabs [data-section]');
        const sections = document.querySelectorAll('.grid [data-section]');
        function select(name){
          sections.forEach(s=>{
            const show = s.getAttribute('data-section')===name;
            s.style.display = show ? 'block' : 'none';
          });
          localStorage.setItem('admin.tab', name);
        }
        buttons.forEach(b=>b.addEventListener('click', ()=>select(b.getAttribute('data-section'))));
        select(localStorage.getItem('admin.tab')||'config');
      })();
      async function restart() {
        const res = await fetch('/admin/restart', {method: 'POST'});
        if (res.ok) alert('Restart scheduled.'); else alert('Restart failed.');
      }
      async function syncAssistant() {
        const res = await fetch('/admin/api/assistant/sync', {method:'POST'});
        const data = await res.json();
        document.getElementById('msg').textContent = (data.ok !== false) ? (data.message||'Synced') : ('Error: '+data.error);
        await loadAssistantInfo();
      }
      async function loadAssistantInfo() {
        try {
          const res = await fetch('/admin/api/assistant/info');
          const data = await res.json();
          document.getElementById('assistant-info').textContent = JSON.stringify(data, null, 2);
          document.getElementById('assistant-badge').textContent = 'Assistant: ' + (data.assistant_id || '-');
          document.getElementById('model-badge').textContent = 'Model: ' + (data.model || '-');
        } catch (e) {
          document.getElementById('assistant-info').textContent = 'Failed to load assistant info';
        }
      }
      async function loadHealth() {
        try {
          const res = await fetch('/health');
          const data = await res.json();
          document.getElementById('health').textContent = JSON.stringify(data, null, 2);
        } catch (e) {
          document.getElementById('health').textContent = 'Failed to load health';
        }
      }
      async function loadLogs() {
        try {
          const res = await fetch('/admin/api/logs?path=app.log&lines=200');
          const data = await res.json();
          if (data.ok) {
            document.getElementById('logs').textContent = data.lines.join('\n');
          } else {
            document.getElementById('logs').textContent = 'Error: ' + (data.error||'unknown');
          }
        } catch (e) {
          document.getElementById('logs').textContent = 'Failed to load logs';
        }
      }
      async function testMCP() {
        try {
          const res = await fetch('/admin/api/mcp/list-tools', {method:'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({})});
          const data = await res.json();
          const el = document.getElementById('mcp-result') || document.getElementById('logs');
          el.textContent = JSON.stringify(data, null, 2);
        } catch (e) {
          const el = document.getElementById('mcp-result') || document.getElementById('logs');
          el.textContent = 'Failed to test MCP';
        }
      }
      function mcpRowTemplate(idx, value){
        const safe = value || '';
        return `<div class="row" data-idx="${idx}">
          <label>Server ${idx+1}</label>
          <div>
            <input type="text" class="mcp-url" value="${safe}" style="width:100%"/>
            <div class="actions" style="margin-top:6px;">
              <button class="btn" type="button" onclick="mcpValidate(${idx})">Validate</button>
              <button class="btn" type="button" onclick="mcpListTools(${idx})">List Tools</button>
              <button class="btn danger" type="button" onclick="mcpRemove(${idx})">Remove</button>
            </div>
            <div class="code" id="mcp-result-${idx}"></div>
          </div>
        </div>`;
      }
      function mcpRenderRows(list){
        const box = document.getElementById('mcp-rows');
        box.innerHTML = '';
        list.forEach((v,i)=>{ const wrap = document.createElement('div'); wrap.innerHTML = mcpRowTemplate(i, v); box.appendChild(wrap.firstChild); });
      }
      function mcpGetList(){
        const rows = Array.from(document.querySelectorAll('#mcp-rows .row'));
        return rows.map(r=>{ const input = r.querySelector('.mcp-url'); return (input && input.value.trim()) || ''; }).filter(Boolean);
      }
      function mcpAddRow(){
        const list = mcpGetList(); list.push(''); mcpRenderRows(list);
      }
      function mcpRemove(idx){
        const list = mcpGetList(); list.splice(idx,1); mcpRenderRows(list);
      }
      async function mcpValidate(idx){
        const list = mcpGetList(); const url = list[idx];
        const res = await fetch('/admin/api/mcp/validate', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(url)});
        const data = await res.json();
        document.getElementById('mcp-result-'+idx).textContent = data.ok ? ('OK: '+(data.tools_count||0)+' tools') : ('Error: '+(data.error||'unknown'));
      }
      async function mcpListTools(idx){
        const list = mcpGetList(); const url = list[idx];
        const res = await fetch('/admin/api/mcp/list-tools', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(url)});
        const data = await res.json();
        document.getElementById('mcp-result-'+idx).textContent = JSON.stringify(data, null, 2);
      }
      // Serialize MCP servers into hidden field on save
      document.getElementById('cfg-form').addEventListener('submit', (e)=>{
        const list = mcpGetList();
        document.getElementById('MCP_SERVERS').value = list.join(',');
      });
      // Initialize MCP rows from current value
      (function(){
        const current = (document.getElementById('MCP_SERVERS').value||'').split(',').map(s=>s.trim()).filter(Boolean);
        mcpRenderRows(current.length? current : ['']);
      })();
      async function summarizeLogs(){
        try{
          const res = await fetch('/admin/api/ai/summarize-logs', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({lines:300})});
          const data = await res.json();
          document.getElementById('logs-summary').textContent = data.ok ? data.summary : ('Error: '+(data.error||'unknown'));
        }catch(e){ document.getElementById('logs-summary').textContent = 'Failed to summarize'; }
      }
      async function twilioTestSend(){
        const to = document.getElementById('tw-to').value.trim();
        const message = document.getElementById('tw-body').value;
        const res = await fetch('/admin/api/twilio/test-send', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({to, message})});
        const data = await res.json();
        document.getElementById('tw-result').textContent = data.ok ? ('Sent SID: '+data.sid+' status: '+(data.status||'-')) : ('Error: '+(data.error||'unknown'));
      }
      async function addLocalMCP() {
        const res = await fetch('/admin/api/examples/add-local-mcp', {method:'POST'});
        const data = await res.json();
        document.getElementById('msg').textContent = data.ok ? 'Example MCP server added to config.' : ('Error: '+(data.error||'unknown'));
      }
      let TOOLS_ALL = [];
      let TOOLS_ENABLED = [];
      function renderToolCheckboxes() {
        const box = document.getElementById('tools-list');
        if (!TOOLS_ALL.length) { box.textContent = 'No tools available'; return; }
        const enabledSet = new Set(TOOLS_ENABLED.map(n => n.toLowerCase()));
        let html = [];
        for (const t of TOOLS_ALL) {
          const name = t.name;
          const checked = (TOOLS_ENABLED[0] === '*' || enabledSet.has(name.toLowerCase()));
          html.push(`[ ] ${name}: ${t.description}`); // textual fallback for non-JS environments
        }
        // Replace with interactive checkboxes
        let container = document.createElement('div');
        for (const t of TOOLS_ALL) {
          const row = document.createElement('div');
          const id = 'tool-'+t.name;
          row.innerHTML = `<label><input type="checkbox" id="${id}"> ${t.name}</label> <span class="hint">${t.description||''}</span>`;
          container.appendChild(row);
          setTimeout(()=>{ const cb = document.getElementById(id); if (cb) cb.checked = (TOOLS_ENABLED[0]==='*' || TOOLS_ENABLED.map(n=>n.toLowerCase()).includes(t.name.toLowerCase())); },0);
        }
        box.innerHTML = '';
        box.appendChild(container);
      }
      function renderEffectiveSchema(effective) {
        document.getElementById('tools-schema').textContent = JSON.stringify(effective, null, 2);
      }
      async function loadTools() {
        const res = await fetch('/admin/api/tools');
        const data = await res.json();
        if (!data.ok) { document.getElementById('tools-list').textContent = 'Failed to load tools'; return; }
        TOOLS_ALL = data.all || [];
        TOOLS_ENABLED = data.enabled_names || ['*'];
        document.getElementById('enable-all').checked = (TOOLS_ENABLED.length===1 && TOOLS_ENABLED[0]==='*');
        renderToolCheckboxes();
        renderEffectiveSchema(data.effective||[]);
      }
      function toggleEnableAll(){
        const all = document.getElementById('enable-all').checked;
        if (all) {
          TOOLS_ENABLED = ['*'];
        } else {
          TOOLS_ENABLED = TOOLS_ALL.map(t=>t.name); // default select all; user can uncheck
        }
        renderToolCheckboxes();
      }
      async function applyToolSelection() {
        const all = document.getElementById('enable-all').checked;
        let payload;
        if (all) {
          payload = {all:true};
        } else {
          const names = [];
          for (const t of TOOLS_ALL) {
            const cb = document.getElementById('tool-'+t.name);
            if (cb && cb.checked) names.push(t.name);
          }
          payload = names;
        }
        const r2 = await fetch('/admin/api/tools/enable', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        const d2 = await r2.json();
        document.getElementById('msg').textContent = d2.ok ? ('Enabled tools updated') : ('Error: '+(d2.error||'unknown'));
        await loadTools();
      }
      async function exportConfig() {
        const res = await fetch('/admin/api/config/export');
        const data = await res.json();
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'wotbot-config.json';
        a.click();
      }
      document.getElementById('import-file').addEventListener('change', async (e)=>{
        const file = e.target.files[0];
        if (!file) return;
        const text = await file.text();
        try {
          const payload = JSON.parse(text);
          const res = await fetch('/admin/api/config/import', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
          const data = await res.json();
          document.getElementById('import-result').textContent = data.ok ? 'Import successful' : ('Error: '+(data.error||'unknown'));
        } catch (err) {
          document.getElementById('import-result').textContent = 'Invalid JSON file';
        }
      });
      async function askAI(){
        const q = document.getElementById('ai-q').value||'';
        const payload = {question:q, include_logs: document.getElementById('ai-logs').checked, include_health: document.getElementById('ai-health').checked, include_tools: document.getElementById('ai-tools').checked};
        const res = await fetch('/admin/api/ai/ask', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload)});
        const data = await res.json();
        document.getElementById('ai-answer').textContent = data.ok ? data.answer : ('Error: '+(data.error||'unknown'));
      }
      async function fetchModels(){
        try{
          const res = await fetch('/admin/api/openai/models');
          const data = await res.json();
          document.getElementById('models').textContent = data.ok ? (data.models||[]).join('\n') : ('Error: '+(data.error||'unknown'));
        }catch(e){ document.getElementById('models').textContent='Failed to load models'; }
      }
      // On load
      loadAssistantInfo();
      loadHealth();
      loadTools();
    </script>
  </body>
  </html>
